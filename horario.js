"/portal/mis_fichadas"===window.location.pathname&&_Horario(),"/portal/novedades_asistencia"===window.location.pathname&&_Asistencia();var server="https://gtorresdx.github.io/rrhhHorario/";function _Horario(){$.getScript("http://momentjs.com/downloads/moment-with-locales.min.js",function(){moment.locale("es");var a=obtenerHorario(348e5),o=18e5;calcular(a,o),$("select").on("change",function(){setCookie($(this).attr("dataDate"),$(this).val(),60),calcular(a,o)}),$.getScript(server+"jquery-clock-timepicker.min.js",function(){$(".boletaInst").clockTimePicker(),$(".boletaInst").on("change",function(){setCookie($(this).attr("dataDate"),$(this).val(),60),calcular(a,o)})})})}function _Asistencia(){$.getScript("http://momentjs.com/downloads/moment-with-locales.min.js",function(){moment.locale("en"),asistencia()})}function calcular(a,o){var e=$("main div.container div.row > div.col")[0];horaIngreso=null,n=nombreUsuario(),dia=null,$(e).children().each(function(e,t){var i=null,r=0,s=0;switch(e){case 1:horaIngreso=obtenerHoraIngreso(t),dia=obtenerDia(t);break;case 2:if((i=obtenerFichadas(t)).length>0){var d=calcularPermanencia(horaIngreso,i,a,o,n,dia),c="Hora de ingreso: "+horaIngreso.format("HH:mm:ss");Cargarformulario(t,dia),mostrar(d,t,c,horaIngreso,a,o),r=compensacion(d,horaIngreso,a,o),s=d.enEdificio,setCookie(n+dia,r,60),setCookie(n+dia+"enEdificio",s,60),historicoSemana(dia,t)}break;case 4:dia=obtenerDia(t),null!==dia&&""!==dia&&(horaIngreso=obtenerHoraIngreso(t));break;case 5:if((i=obtenerFichadas(t)).length>0){d=calcularPermanencia(horaIngreso,i,a,o,n,dia),c="Hora de ingreso: "+horaIngreso.format("HH:mm:ss");Cargarformulario(t,dia),mostrar(d,t,c,horaIngreso,a,o),r=compensacion(d,horaIngreso,a,o),s=d.enEdificio,setCookie(n+dia,r,60),setCookie(n+dia+"enEdificio",s,60),historicoSemana(dia,t)}}})}function obtenerHoraIngreso(a){try{var o=moment($(a).find(" > div:last-child center").html().trim(),"HH:mm")}catch(a){console.log("Error en obtenerHoraIngreso (horario Administrativo)"),console.log(a)}try{var e=moment($(a).find("h1.black-text center").html().trim().slice(-8),"HH:mm:ss")}catch(a){e=o;console.log("Error en obtenerHoraIngreso (Primera Fichada)"),console.log(a)}switch(getCookie(n+dia+"comision")){case"Entrada":return o;default:return EsControlable()?e>o?e:o:e}}function obtenerHorario(a){var o=$("main div.container div.row > div.col")[0],e=moment(),t=moment(),i=a,r=!1;return $(o).children().each(function(a,o){switch(a){case 1:try{e=moment($(o).find(" > div:last-child center").html().trim(),"HH:mm");var n=$(o).find(" > div:last-child center");t=moment($(n[1]).html().trim(),"HH:mm"),i=t.diff(e)}catch(a){console.log("Error en obtener horarios"),console.log(a),r=!0}break;case 4:if(r)try{e=moment($(o).find(" > div:last-child center").html().trim(),"HH:mm");n=$(o).find(" > div:last-child center");t=moment($(n[1]).html().trim(),"HH:mm"),i=t.diff(e)}catch(a){console.log("Error en obtener horarios"),console.log(a)}}}),{horarioIngreso:e,horarioEgreso:t,Ths:i}}function obtenerFichadas(a){var o=[],e="",t="";return $(a).find("#tabla3 tbody tr").each(function(){var a="HH:mm:ss";hora=$(this).find("td:nth(0)").html(),hora.indexOf(" ")>0&&(a="DD-MM-YYYY "+a),hh=moment(hora,a),(e=$(this).find("td:nth(1)").html())!=t&&o.push({fichada:hh,tipo:e}),t=e}),o}function calcularPermanencia(a,o,e,t,i,r){var n=0,s=0,d=0;getCookie(i+r+"comision");if(o.length>0){o[0]={fichada:a,tipo:"Entrada"};for(var c=1;c<o.length;c+=2)n+=moment.duration(o[c].fichada.diff(o[c-1].fichada));var l=moment();"Entrada"==o[o.length-1].tipo?(n+=moment.duration(l.diff(o[o.length-1].fichada)),ultima=l,d=e.Ths-t-n):ultima=o[o.length-1].fichada,s=moment.duration(ultima.diff(o[0].fichada))}return{enEdificio:n,fuera:s-n,falta:d,total:s}}function Cargarformulario(a,o){var e=$(a).find(".resumen"),t=document.getElementById("linkestilo"),i=(new Date).getTime();if(null===t&&($("head").append('<link type="text/css" href="'+server+"Horario.css?t="+i+'" rel="Stylesheet" id="linkestilo">'),$("head").append('<link type="text/css" href="'+server+"bootstrap.css?t="+i+'" rel="Stylesheet" id="linkestilo">')),null===e||0===e.length){var r;$.ajax({type:"GET",url:server+"Horario.html?t="+i,async:!1,success:function(a){r=a}}),$(a).append(r);var n=nombreUsuario();SetearComision(a,getCookie(n+o+"comision"),o),SetearBoleta(a,getCookie(n+o+"boleta"),o),BotonSonidoView(),$(".licencia").attr("href",server+"License.txt")}}function BotonSonidoView(){$(".salida").click(function(){SonidoView()})}function mostrar(a,o,e,t,i,r){var n=$(o).find(".resumen"),s=compensacion(a,t,i,r),d=$(n).find("table tbody tr"),c=0;if(0!==a.falta){var l=moment().add(a.falta,"ms"),m=t.add(i.Ths,"ms");(l>m||s<0)&&a.enEdificio>216e5?(c=CalcualarBoleta(l,m,a.fuera,r,a,i),l>m&&(l=m)):l>m&&(l=m),l<moment()&&0===$("main div.container").find("div.chau").length&&($("main div.container").prepend('<div class="chau col s12" style="background-color:orange;"><h3 style="background-color:orange;"><center>¡¡Chauuu!! Te podes ir <i class="fa fa-hand-stop-o" aria-hidden="true"></i></center></h1></div>'),parpadear(),window.actualizarSonido||(SonidoView(),alerta("Horario cumplido","info"),window.actualizarSonido=setInterval(function(){alerta("Horario cumplido","info")},10500))),window.actualizarPermanencia||(window.actualizarPermanencia=setInterval(function(){calcular(i,r)},1e3))}else{n=t.clone();((l=t.add(a.total.asMilliseconds(),"ms"))>(m=n.add(i.Ths,"ms"))||s<0)&&a.enEdificio>216e5&&(c=CalcualarBoleta(l,m,a.fuera,r,a,i))}c=CalcualarBoleta(l,m,a.fuera,r,a,i),$(n).find("span.fuera").html(formatearHora(a.fuera)),$(d).find(".fuera").html(formatearHora(a.fuera)),$(n).find("span.edificio").html(formatearHora(a.enEdificio)),$(d).find(".edificio").html('<i class="fa fa-home"></i> '+formatearHora(a.enEdificio)),$(d).find(".edificio").removeClass().addClass("label label-info edificio"),a.enEdificio<216e5&&$(d).find(".edificio").removeClass().addClass("label label-danger edificio"),s>0?$(d).find(".compensacion").html(formatearHora(s)):$(d).find(".compensacion").html(formatearHora(0)),c>0?($(d).find(".boleta").html(formatearHora(c)),$(d).find(".boleta").removeClass().addClass("label label-danger boleta")):($(d).find(".boleta").html(formatearHora(0)),$(d).find(".boleta").removeClass().addClass("boleta")),$(n).find("span.salida").html(l.format("HH:mm:ss")),$(d).find(".salida").html('<i class="fa fa-sign-out"></i> '+l.format("HH:mm:ss"));var f=$(o).find(".resumen div.box-header .box-title")[0];$(f).html("Resumen del día( "+e+")")}function CalcualarBoletaOld(a,o,e,t,i,r){var n=0;return a>o?(n=e-t,console.log("B1")):(console.log("B2"),n=r.Ths-i.enEdificio-t),n>0?n:0}function CalcualarBoleta(a,o,e,t,i,r){var n,s,d=0;return(d=(n=e-t)>(s=r.Ths-i.enEdificio-t)?n:s)>0?d:0}function obtenerComision(a){var o="",e=$(a).find(".resumen"),t=$(e).find("table tbody tr");0===!t.length&&(o=$(t).find(".comision").val());return o}function SetearComision(a,o,e){var t=$(a).find(".resumen"),i=$(t).find("table tbody tr");if(0!==i.length){var r=$(i).find(".comision");r.val(o),n=nombreUsuario(),r.attr("dataDate",n+e+"comision")}}function obtenerBoleta(a){var o="",e=$(a).find(".resumen"),t=$(e).find("table tbody tr");0===!t.length&&(o=$(t).find(".boletaInst").val());return o}function obtenerBoletaDuration(a){var o=moment("00:00","HH:mm"),e=moment.duration(o.diff(o)),t=getCookie(n+dia+"boleta");if(""!==t){var i=moment(t,"HH:mm");e=moment.duration(i.diff(o))}return e}function SetearBoleta(a,o,e){var t=$(a).find(".resumen"),i=$(t).find("table tbody tr");if(0!==i.length){var r=$(i).find(".boletaInst");r.val(o),n=nombreUsuario(),r.attr("dataDate",n+e+"boleta")}}function compensacion(a,o,e,t){var i=0;switch(getCookie(n+dia+"comision")){case"Salida":case"Día":i=0;break;default:if(a.total>0)if(a.falta<=0&&a.fuera<=t&&a.enEdificio>e.Ths-t){if(i=a.total-e.Ths,""!==getCookie(n+dia+"boleta"))i+=obtenerBoletaDuration();i<0&&(i=0)}else{if(i=a.total-e.Ths-(a.fuera-t),""!==getCookie(n+dia+"boleta"))i+=obtenerBoletaDuration()}}var r=72e5;return e.Ths>=288e5&&(r=48e5),i>r&&(i=r),i}function formatearHora(a){var o=moment.duration(a);return pad(o.get("h"),2)+":"+pad(o.get("m"),2)+":"+pad(o.get("s"),2)}function formatearHoraH(a){var o=moment.duration(a),e=parseInt(o.asHours()),t=moment.duration(o-moment.duration(e,"hours")).minutes();return pad(e,2)+":"+pad(t,2)}function pad(a,o){for(var e=a+"";e.length<o;)e="0"+e;return e}function obtenerDia(a){var o="";try{o=$(a).find("h5 center").html().trim()}catch(a){console.log("Error en obtener dia")}return o}function setCookie(a,o,e){var t=new Date;t.setTime(t.getTime()+24*e*60*60*1e3);var i="expires="+t.toUTCString();document.cookie=a+"="+o+";"+i+";path=/"}function getCookie(a){for(var o=a+"=",e=document.cookie.split(";"),t=0;t<e.length;t++){for(var i=e[t];" "==i.charAt(0);)i=i.substring(1);if(0===i.indexOf(o))return i.substring(o.length,i.length)}return""}function ProcesarDia(a){$("#fecha_historial").val(a),$(".btn").trigger("click")}function diadelaSemana(a,o){for(var e=!1,t=0;t<=6;t+=1)if(a.day(t).format("YYYYMMDD")===o.format("YYYYMMDD")){e=!0;break}return e}function historicoSemana(a,o){for(var e=moment(a,"DD-MM-YYYY"),t=moment(moment().format("DD-MM-YYYY"),"DD-MM-YYYY"),i=null,r=0,n=0,s="<li><b>Compensación:</b></li><br />",d="<li><b>En Edificio:</b></li><br />",c=nombreUsuario(),l=1;l<6;l+=1)e.day(l)<=t&&(s+='<div class="col-md-2">',s+='<div class="box box-default">',""!==(i=getCookie(c+e.day(l).format("DD-MM-YYYY")))?(r+=1*i,e.day(l)<t&&1*i,s+='<div class="box-header with-border">',s+='\t<h3 style="text-align:center;background-color:transparent;color:#444;font-variant:normal;" class="box-title">',s+=e.day(l).format("dddd"),s+="\t</h3>",s+="</div>",s+='<div class="box-body" style="text-align:center;">',s+=""+formatearHora(1*i),s+="</div>",s+='<div style="background:#f4f4f4;font-size:13px;" class="box-footer text-center">',s+="\t<a href=\"javascript:ProcesarDia('"+e.day(l).format("DD-MM-YYYY")+"')\"> Actualizar",s+='\t\t<i class="fa fa-refresh"></i>',s+="\t</a>",s+="</div>"):(s+='<div class="box-header with-border">',s+='\t<h3 style="text-align:center;background-color:transparent;color:#444;font-variant:normal;" class="box-title">',s+=e.day(l).format("dddd"),s+="\t</h3>",s+="</div>",s+='<div class="box-body" style="text-align:center;">',s+=""+formatearHora(0),s+="</div>",s+='<div style="background:#f4f4f4;font-size:13px;" class="box-footer text-center">',s+="\t<a href=\"javascript:ProcesarDia('"+e.day(l).format("DD-MM-YYYY")+"')\"> Actualizar",s+='\t\t<i class="fa fa-refresh"></i>',s+="\t</a>",s+="</div>"),s+="</div>",s+="</div>",d+='<div class="col-md-2">',d+='<div class="box box-default">',k2=getCookie(c+e.day(l).format("DD-MM-YYYY")+"enEdificio"),""!==k2?(n+=1*k2,d+='<div class="box-header with-border">',d+='\t<h3 style="text-align:center;background-color:transparent;color:#444;font-variant:normal;" class="box-title">',d+=e.day(l).format("dddd"),d+="\t</h3>",d+="</div>",d+='<div class="box-body" style="text-align:center;">',d+=""+formatearHora(1*k2),d+="</div>",d+='<div style="background:#f4f4f4;font-size:13px;" class="box-footer text-center">',d+="\t<a href=\"javascript:ProcesarDia('"+e.day(l).format("DD-MM-YYYY")+"')\"> Actualizar",d+='\t\t<i class="fa fa-refresh"></i>',d+="\t</a>",d+="</div>"):(d+='<div class="box-header with-border">',d+='\t<h3 style="text-align:center;background-color:transparent;color:#444;font-variant:normal;" class="box-title">',d+=e.day(l).format("dddd"),d+="\t</h3>",d+="</div>",d+='<div class="box-body" style="text-align:center;">',d+=""+formatearHora(0),d+="</div>",d+='<div style="background:#f4f4f4;font-size:13px;" class="box-footer text-center">',d+="\t<a href=\"javascript:ProcesarDia('"+e.day(l).format("DD-MM-YYYY")+"')\"> Actualizar",d+='\t\t<i class="fa fa-refresh"></i>',d+="\t</a>",d+="</div>"),d+="</div>",d+="</div>");var m='<div class="row"><div class="col-xs-12">'+s+'</div></div><div class="row"><div class="col-xs-12">'+d+"</div></div>";$(o).find("span.hist").html(m),$(o).find("span.s-compensacion").html(formatearHora(r)),$(o).find("span.s-enedificio").html(formatearHoraH(n))}function EsControlable(){var a=!1;return $("main div.container img").each(function(o,e){"Controlable"===$(e).attr("data-tooltip")&&(a=!0)}),a}function nombreUsuario(){return $("#header-nombre-usuario").text().trim()}function asistencia(){n=nombreUsuario(),$("#mi_asistencia_tbl tbody tr").each(function(a){comp=0,Edif=0,obj=null,$(this).children("td").each(function(a){switch(a){case 0:d=moment($(this).text(),"DD-MMM-YY"),obj=$(this);break;case 1:comp+=mostraDatosComp(n,d,$(this),1),Edif+=mostraDatosEnEdif(n,d,$(this),1);break;case 2:comp+=mostraDatosComp(n,d,$(this),2),Edif+=mostraDatosEnEdif(n,d,$(this),2);break;case 3:comp+=mostraDatosComp(n,d,$(this),3),Edif+=mostraDatosEnEdif(n,d,$(this),3);break;case 4:comp+=mostraDatosComp(n,d,$(this),4),Edif+=mostraDatosEnEdif(n,d,$(this),4);break;case 5:comp+=mostraDatosComp(n,d,$(this),5),Edif+=mostraDatosEnEdif(n,d,$(this),5)}}),s=obj.html(),obj.html(s+"<br/>Comp: "+formatearHoraH(comp)+"<br/>en Edif: "+formatearHoraH(Edif))})}function mostraDatosComp(a,o,e,t){return k=getCookie(a+o.day(t).format("DD-MM-YYYY")),compensa=0,""!==k&&(compensa=1*k),s=e.html(),e.html(s+"<br/>Comp: "+formatearHora(compensa)),compensa}function mostraDatosEnEdif(a,o,e,t){return Edif=0,k2=getCookie(a+o.day(t).format("DD-MM-YYYY")+"enEdificio"),""!==k2&&(Edif=1*k2),s=e.html(),e.html(s+"<br/>en Edif: "+formatearHora(Edif)),Edif}function parpadear(){$(".chau").fadeIn(350).delay(150).fadeOut(350,parpadear)}function SonidoView(){$($("#chat-message-audio")[0]).attr("src",server+"sonido.mp3"),$("#chat-message-audio")[0].load(),$("#chat-message-audio")[0].play()}function dragElement(a){var o=0,e=0,t=0,i=0;function r(a){a=a||window.event,t=a.clientX,i=a.clientY,document.onmouseup=s,document.onmousemove=n}function n(r){r=r||window.event,o=t-r.clientX,e=i-r.clientY,t=r.clientX,i=r.clientY,a.style.top=a.offsetTop-e+"px",a.style.left=a.offsetLeft-o+"px"}function s(){document.onmouseup=null,document.onmousemove=null}document.getElementById(a.id+"header")?document.getElementById(a.id+"header").onmousedown=r:a.onmousedown=r}
